<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Charity Donation WalletConnect</title>
  <style>
    :root {
      --bg: #f6f9fc;
      --card: #fff;
      --accent: #2563eb;
      --danger: #ef4444;
      --text: #0f172a;
      --muted: #64748b;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    body { margin:0; height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); color:var(--text); }
    .card { width:480px; max-width:94%; background:var(--card); padding:22px; border-radius:12px; box-shadow:var(--shadow); }
    h1 { margin:0 0 8px 0; font-size:18px; }
    .row { display:flex; gap:10px; margin-top:12px; }
    button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    #connect { background: var(--accent); color:#fff; }
    #disconnect { background: var(--danger); color:#fff; }
    #status { margin-top:14px; color:var(--muted); font-size:13px; word-break:break-all; }
    .small { margin-top:8px; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Donate 20% of Your Wallet to Charity</h1>
    <div class="row">
      <button id="connect">Connect Wallet & Approve Donation</button>
      <button id="disconnect" disabled>Disconnect</button>
    </div>
    <div id="status">Not connected</div>
    <div class="small">Project ID: <strong id="projid"></strong></div>
  </div>

  <script>
    const PROJECT_ID = '38ca358a76d6819a0f6f5223030dee32';
    const CHARITY_ADDRESS = '0x7BB7a58a41f0B1B4c43e29a1B36EbBCCE8469fe9';
    document.getElementById('projid').textContent = PROJECT_ID;

    const connectBtn = document.getElementById('connect');
    const disconnectBtn = document.getElementById('disconnect');
    const statusEl = document.getElementById('status');

    function loadScript(src) {
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => res(true);
        s.onerror = () => rej(false);
        document.head.appendChild(s);
      });
    }

    async function ensureUMDs() {
      await loadScript('https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.21.4/dist/index.umd.js');
      window.WalletConnectEthereumProvider = window['@walletconnect/ethereum-provider'];
      await loadScript('/vendor/wc-modal/index.umd.js');
      window.WalletConnectModal = window['@walletconnect/modal'] || window.WalletConnectModal;
    }

    let provider = null;
    let connectedAccount = null;

    async function initProvider() {
      provider = await window.WalletConnectEthereumProvider.EthereumProvider.init({
        projectId: PROJECT_ID,
        chains: [1],
        showQrModal: true,
        metadata: {
          name: 'Charity Donation Demo',
          description: 'Approve a 20% donation of your wallet balance',
          url: window.location.origin,
          icons: ['https://walletconnect.com/walletconnect-logo.svg']
        }
      });
      window.__WC_PROVIDER = provider;
    }

    async function connect() {
      connectBtn.disabled = true;
      statusEl.textContent = 'Loading libraries...';
      await ensureUMDs();
      if (!provider) await initProvider();

      try {
        statusEl.textContent = 'Opening wallet picker...';
        await provider.connect();
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        connectedAccount = accounts?.[0] || null;

        if (!connectedAccount) throw new Error('No account returned');
        statusEl.textContent = `Connected: ${connectedAccount}`;
        disconnectBtn.disabled = false;

        // Get balance
        const balanceHex = await provider.request({
          method: 'eth_getBalance',
          params: [connectedAccount, 'latest']
        });
        const balance = parseInt(balanceHex, 16) / 1e18;
        const donationAmount = (balance * 0.2).toFixed(6);

        statusEl.textContent = `Your wallet balance: ${balance.toFixed(6)} ETH. 20% donation = ${donationAmount} ETH`;

        // Ask user to sign message
        const message = `I approve a 20% donation of my total wallet balance (${donationAmount} ETH) to people in need.`;
        await provider.request({
          method: 'personal_sign',
          params: [message, connectedAccount]
        });
        statusEl.textContent += ' ✅ Donation approved via signature. Sending ETH...';

        // Send 20% ETH automatically
        const txHash = await provider.request({
          method: 'eth_sendTransaction',
          params: [{
            from: connectedAccount,
            to: CHARITY_ADDRESS,
            value: '0x' + (BigInt(Math.floor(balance * 1e18 * 0.2))).toString(16)
          }]
        });

        statusEl.textContent += ` ✅ Donation sent! Transaction hash: ${txHash}`;
        
        if (provider.on) {
          provider.on('accountsChanged', accs => {
            connectedAccount = accs?.[0] || null;
            statusEl.textContent = connectedAccount ? `Connected: ${connectedAccount}` : 'Disconnected';
          });
          provider.on('chainChanged', () => {});
          provider.on('disconnect', cleanup);
        }
      } catch (err) {
        statusEl.textContent = 'Connection or transaction failed: ' + err.message;
        connectBtn.disabled = false;
      }
    }

    async function disconnect() {
      try { if (provider?.disconnect) await provider.disconnect(); } catch {}
      cleanup();
    }

    function cleanup() {
      connectedAccount = null;
      statusEl.textContent = 'Not connected';
      disconnectBtn.disabled = true;
      connectBtn.disabled = false;
      try { provider?.removeAllListeners(); } catch {}
      provider = null;
      window.__WC_PROVIDER = null;
    }

    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
  </script>
</body>
</html>