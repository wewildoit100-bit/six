<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalletConnect Picker — Light</title>
  <style>
    :root {
      --bg: #f6f9fc;
      --card: #ffffff;
      --accent: #2563eb;
      --danger: #ef4444;
      --text: #0f172a;
      --muted: #64748b;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--text);
    }
    .card {
      width: 480px;
      max-width: 94%;
      background: var(--card);
      padding: 22px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    h1 { margin: 0 0 8px 0; font-size: 18px; }
    .row { display:flex; gap:10px; margin-top:12px; }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    #connect { background: var(--accent); color: #fff; }
    #disconnect { background: var(--danger); color: #fff; }
    #status { margin-top: 14px; color: var(--muted); font-size: 13px; word-break:break-all; }
    pre { margin-top:10px; background:#f1f5f9; padding:10px; border-radius:8px; color:var(--text); max-height:180px; overflow:auto; font-size:13px; }
    .small { margin-top:8px; color:var(--muted); font-size:13px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Connect Wallet (WalletConnect v2 picker)</h1>
    <div class="row">
      <button id="connect">Connect Wallet</button>
      <button id="disconnect" disabled>Disconnect</button>
    </div>
    <div id="status">Not connected</div>
    <pre id="log">Log:</pre>
    <div class="small">Project ID: <strong id="projid"></strong></div>
  </div>

  <script>
    // CONFIG
    const PROJECT_ID = '38ca358a76d6819a0f6f5223030dee32';
    document.getElementById('projid').textContent = PROJECT_ID;

    const connectBtn = document.getElementById('connect');
    const disconnectBtn = document.getElementById('disconnect');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    function log(...args) {
      console.log(...args);
      const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ');
      logEl.textContent += '\n' + s;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Helper: dynamic script loader
    function loadScript(src) {
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => res(src);
        s.onerror = (e) => rej(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });
    }

    // Try CDN urls in order
    async function ensureUMDs() {
      // UMD paths we want to try (jsdelivr first, then unpkg)
      const tries = [
        // provider
        'https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.21.4/dist/index.umd.js',
        'https://unpkg.com/@walletconnect/ethereum-provider@2.21.4/dist/index.umd.js',
        // modal
        'https://cdn.jsdelivr.net/npm/@walletconnect/modal@2.7.0/dist/index.umd.js',
        'https://unpkg.com/@walletconnect/modal@2.7.0/dist/index.umd.js'
      ];

      // We'll attempt each in sequence but ensure both libs loaded. If provider modal order matters, both must load.
      const results = { provider: false, modal: false, errors: [] };

      // load provider first (first two entries)
      for (const url of tries.slice(0,2)) {
        try {
          await loadScript(url);
          if (window && window['@walletconnect/ethereum-provider']) {
            window.WalletConnectEthereumProvider = window['@walletconnect/ethereum-provider'];
            results.provider = true;
            log('Loaded provider UMD from', url);
            break;
          }
        } catch (e) {
          results.errors.push(e.message || String(e));
          log('Provider load failed for', url, e.message || e);
        }
      }

      // load modal next (next two entries)
      for (const url of tries.slice(2,4)) {
        try {
          await loadScript(url);
          if (window && window['@walletconnect/modal']) {
            window.WalletConnectModal = window['@walletconnect/modal'];
            results.modal = true;
            log('Loaded modal UMD from', url);
            break;
          }
        } catch (e) {
          results.errors.push(e.message || String(e));
          log('Modal load failed for', url, e.message || e);
        }
      }

      return results;
    }

    // Initialize provider
    let provider = null;
    let connectedAccount = null;

    async function initProvider() {
      if (!window.WalletConnectEthereumProvider) throw new Error('WalletConnect EthereumProvider UMD missing');
      provider = await window.WalletConnectEthereumProvider.EthereumProvider.init({
        projectId: PROJECT_ID,
        chains: [1],
        showQrModal: true,
        metadata: {
          name: 'Codespace WalletConnect Light Demo',
          description: 'Wallet picker demo',
          url: window.location.origin,
          icons: ['https://walletconnect.com/walletconnect-logo.svg']
        }
      });
      window.__WC_PROVIDER = provider;
      log('Provider initialized.');
    }

    async function connect() {
      connectBtn.disabled = true;
      statusEl.textContent = 'Loading libraries...';
      let umdStatus;
      try {
        umdStatus = await ensureUMDs();
      } catch (e) {
        log('CDN load exception', e);
        umdStatus = { provider:false, modal:false, errors:[e.message||String(e)] };
      }

      if (!umdStatus.provider) {
        statusEl.textContent = 'Failed to load WalletConnect provider (check network/CDN).';
        log('UMD provider failed. Errors:', umdStatus.errors);
        connectBtn.disabled = false;
        return;
      }

      if (!provider) {
        try { await initProvider(); } catch (e) {
          log('initProvider failed:', e && e.message ? e.message : e);
          statusEl.textContent = 'Provider initialization failed — see log.';
          connectBtn.disabled = false;
          return;
        }
      }

      try {
        statusEl.textContent = 'Opening wallet picker...';
        // connect() will open the picker/modal if modal UMD is present; otherwise it attempts pairing/scanning.
        await provider.connect();

        // request accounts
        const accounts = await provider.request({ method: 'eth_requestAccounts' });
        connectedAccount = accounts && accounts[0] ? accounts[0] : null;
        statusEl.textContent = connectedAccount ? `Connected: ${connectedAccount}` : 'Connected (no account returned)';
        disconnectBtn.disabled = false;
        log('Connected accounts:', accounts);

        // events
        if (provider.on) {
          provider.on('accountsChanged', (accs) => {
            log('accountsChanged', accs);
            connectedAccount = accs && accs[0] ? accs[0] : null;
            statusEl.textContent = connectedAccount ? `Connected: ${connectedAccount}` : 'Disconnected';
          });
          provider.on('chainChanged', (chainId) => log('chainChanged', chainId));
          provider.on('disconnect', (code, reason) => {
            log('disconnect', code, reason);
            cleanup();
          });
        }
      } catch (err) {
        log('Connect error:', err && err.message ? err.message : err);
        statusEl.textContent = 'Connection failed — see log';
        connectBtn.disabled = false;
      }
    }

    async function disconnect() {
      try {
        if (provider && provider.disconnect) {
          await provider.disconnect();
          log('provider.disconnect() called');
        }
      } catch (e) {
        log('Disconnect error', e);
      } finally {
        cleanup();
      }
    }

    function cleanup() {
      connectedAccount = null;
      statusEl.textContent = 'Not connected';
      disconnectBtn.disabled = true;
      connectBtn.disabled = false;
      try { if (provider && provider.removeAllListeners) provider.removeAllListeners(); } catch(e) {}
      provider = null;
      window.__WC_PROVIDER = null;
    }

    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);

    // Helpful note in logs on what to do if CDNs are blocked
    log('If CDN fails in Codespace, run locally:');
    log('  npm init -y');
    log('  npm i @walletconnect/ethereum-provider@2.21.4 @walletconnect/modal@2.7.0');
    log('Then serve your folder (so node_modules are accessible), e.g.:');
    log('  npx serve .  OR  npx http-server -c-1');
    log('And change script src to /node_modules/@walletconnect/ethereum-provider/dist/index.umd.js etc if you prefer local includes.');
  </script>
</body>
</html>
